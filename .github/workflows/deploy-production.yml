name: Deploy to Production VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

env:
  DEPLOY_PATH: /home/samuel/sentinel-deployment

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3

    - name: ğŸ” Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: ğŸ“¦ Deploy to VPS
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} <<'EOF'
          set -e
          
          cd ${{ env.DEPLOY_PATH }}
          
          echo "ğŸ›‘ Stopping all services..."
          docker-compose -f docker-compose.yml --env-file .env.production down -v --remove-orphans 2>/dev/null || true
          
          echo "ğŸ—‘ï¸ Force removing sentinel containers..."
          docker ps -a --filter "name=sentinel" -q | xargs -r docker rm -f 2>/dev/null || true
          
          echo "ğŸ§¹ Cleaning up networks..."
          docker network prune -f || true
          
          echo "ğŸ”„ Pulling latest code..."
          git fetch origin main
          git reset --hard origin/main
          
          echo "ğŸ”¨ Building Docker images..."
          docker-compose -f docker-compose.yml --env-file .env.production build --no-cache
          
          echo "ğŸš€ Deploying containers..."
          docker-compose -f docker-compose.yml --env-file .env.production up -d
          
          echo "â³ Waiting for services to start..."
          sleep 20
          
          echo "ğŸ§¹ Cleaning up unused images..."
          docker image prune -f
          
          echo "âœ… Deployment complete!"
          docker ps --filter "name=sentinel" --format "table {{.Names}}\t{{.Status}}"
        EOF

    - name: ğŸ” Health Check
      run: |
        echo "Waiting 30 seconds for services to start..."
        sleep 30
        
        echo "Checking API health..."
        curl -f https://service.sentinel.crudzaso.com/health || echo "API health check failed (might be OK if /health endpoint doesn't exist)"
        
        echo "Checking Frontend..."
        curl -f https://sentinel.crudzaso.com || exit 1

    - name: ğŸ“Š Deployment Summary
      if: always()
      run: |
        echo "### ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** \`${{ job.status }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend:** https://sentinel.crudzaso.com" >> $GITHUB_STEP_SUMMARY
        echo "- **API:** https://service.sentinel.crudzaso.com" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Deployed at:** $(date -u)" >> $GITHUB_STEP_SUMMARY
