using System.Text.Json;

namespace Sentinel.Vulnerability.Service.Services;

public class VolumeFileReader : IResultReader
{
    private readonly string? _resultsBasePath;
    private readonly ILogger<VolumeFileReader>? _logger;

    public VolumeFileReader(IConfiguration configuration, ILogger<VolumeFileReader>? logger = null)
    {
        _logger = logger;
        // Config key opcional: "Files:ResultsBasePath" (ej: /mnt/scan-results)
        _resultsBasePath = configuration["Files:ResultsBasePath"];
    }

    public async Task<string> ReadFileAsync(string path)
    {
        if (string.IsNullOrWhiteSpace(path))
            throw new ArgumentException("Path is null or empty", nameof(path));

        var normalized = GetNormalizedPath(path);

        if (!File.Exists(normalized))
        {
            _logger?.LogWarning("Archivo no existe: {Path}", normalized);
            throw new FileNotFoundException("Resultado no encontrado.", normalized);
        }

        try
        {
            using var fs = File.Open(normalized, FileMode.Open, FileAccess.Read, FileShare.Read);
            using var sr = new StreamReader(fs);
            var content = await sr.ReadToEndAsync();
            return content;
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Error leyendo archivo {Path}", normalized);
            throw new InvalidOperationException($"Error leyendo archivo: {ex.Message}", ex);
        }
    }

    public async Task<T> ReadJsonAsync<T>(string path)
    {
        var content = await ReadFileAsync(path);
        try
        {
            var options = new JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true,
            };
            var obj = JsonSerializer.Deserialize<T>(content, options);
            if (obj == null)
                throw new InvalidOperationException("Deserialización retornó null.");

            return obj;
        }
        catch (JsonException jex)
        {
            _logger?.LogError(jex, "Error deserializando JSON del archivo {Path}", path);
            throw new InvalidOperationException($"Error deserializando JSON: {jex.Message}", jex);
        }
    }

    private string GetNormalizedPath(string requestedPath)
    {
        // Si se configuró una ruta base, aseguramos que el archivo solicitado esté dentro de ella
        if (!string.IsNullOrEmpty(_resultsBasePath))
        {
            var normalizedBase = Path.GetFullPath(_resultsBasePath);
            string normalizedRequested;

            try
            {
                normalizedRequested = Path.GetFullPath(requestedPath);
            }
            catch (Exception ex)
            {
                _logger?.LogWarning(ex, "Ruta solicitada inválida: {Path}", requestedPath);
                throw new ArgumentException("FilePath inválido", nameof(requestedPath));
            }

            if (!normalizedRequested.StartsWith(normalizedBase, StringComparison.OrdinalIgnoreCase))
            {
                _logger?.LogWarning("Intento de acceso fuera del volumen permitido. Base={Base} Requested={Requested}",
                    normalizedBase, normalizedRequested);
                throw new UnauthorizedAccessException("FilePath fuera del volumen permitido.");
            }

            return normalizedRequested;
        }

        // Si no hay base configurada, devolvemos la ruta absoluta normalizada
        return Path.GetFullPath(requestedPath);
    }
}