# ğŸ” Sentinel Vulnerability Service

**Sentinel Vulnerability Service** is a specialized microservice responsible for processing and aggregating vulnerability scan results from multiple security tools (Trivy, OWASP ZAP). It normalizes findings from different sources, aggregates them by scan ID, and publishes consolidated results to RabbitMQ for downstream consumption.

---

## ğŸ“‹ Table of Contents

- [Features](#-features)
- [Architecture](#-architecture)
- [Prerequisites](#-prerequisites)
- [Installation](#-installation)
- [Configuration](#-configuration)
- [Usage](#-usage)
- [API Endpoints](#-api-endpoints)
- [Supported Tools](#-supported-tools)
- [Data Structures](#-data-structures)
- [RabbitMQ Integration](#-rabbitmq-integration)
- [File Reading](#-file-reading)
- [Troubleshooting](#-troubleshooting)

---

## âœ¨ Features

- âœ… **Multi-Tool Support**: Processes results from Trivy (container/IaC scanning) and OWASP ZAP (web application scanning)
- âœ… **Result Normalization**: Converts different tool formats into a unified vulnerability finding structure
- âœ… **Scan Aggregation**: Combines partial results from multiple tools into a single comprehensive report
- âœ… **RabbitMQ Publisher**: Publishes final aggregated results with automatic retry and connection recovery
- âœ… **Secure File Reading**: Reads scan results from mounted volumes with path validation
- âœ… **Severity Categorization**: Automatically categorizes findings by severity (High, Medium, Low)
- âœ… **Quality Gate Evaluation**: Determines pass/fail status based on vulnerability counts

---

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   n8n    â”‚â”€â”€â”€â”€â”€â–¶â”‚  Vulnerability      â”‚â”€â”€â”€â”€â”€â–¶â”‚  RabbitMQ   â”‚
â”‚ Workflow â”‚      â”‚  Service (.NET)     â”‚      â”‚  Exchange   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                      â”‚                          â”‚
     â”‚                      â–¼                          â–¼
     â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚            â”‚  File Reader     â”‚      â”‚  Downstream      â”‚
     â”‚            â”‚  (Volume Access) â”‚      â”‚  Consumers       â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Trivy / ZAP     â”‚      â”‚  (Notifications, â”‚
                  â”‚  JSON Results    â”‚      â”‚   Reports, etc.) â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Workflow

1. **n8n** executes security scans (Trivy, ZAP)
2. **n8n** saves scan results to shared volume
3. **n8n** sends notification â†’ `POST /api/v1/n8n/vulnerability-ready`
4. **Vulnerability Service** reads and parses result file
5. **Vulnerability Service** normalizes findings to unified format
6. **Vulnerability Service** aggregates results by ScanId
7. **Vulnerability Service** publishes to RabbitMQ
8. **Downstream services** consume final results

---

## ğŸ“¦ Prerequisites

- **.NET 8.0 SDK** or higher
- **RabbitMQ** (localhost:5672 or remote server)
- **Shared Volume** or file system access to scan results
- **(Optional)** Docker for containerized deployment

---

## ğŸš€ Installation

### 1. Clone the Repository

```bash
git clone https://github.com/your-company/sentinel-vulnerability-service.git
cd sentinel-vulnerability-service
```

### 2. Restore Dependencies

```bash
dotnet restore
```

### 3. Build the Project

```bash
dotnet build
```

### 4. Run the Service

```bash
dotnet run
```

The service will be available at:
- **HTTP**: `http://localhost:5114`
- **HTTPS**: `https://localhost:7213`
- **Swagger UI**: `http://localhost:5114/swagger`

---

## âš™ï¸ Configuration

### `appsettings.json`

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "RabbitMQ": {
    "Host": "localhost",
    "Port": 5672,
    "Username": "guest",
    "Password": "guest",
    "Exchange": "scan.results",
    "RoutingKey": "scan.result.final"
  },
  "Files": {
    "ResultsBasePath": "/mnt/scan-results"
  }
}
```

### Environment Variables (Production)

```bash
export RabbitMQ__Host="rabbitmq.prod.com"
export RabbitMQ__Username="sentinel"
export RabbitMQ__Password="super-secret-password"
export Files__ResultsBasePath="/var/scan-results"
```

---

## ğŸ“– Usage

### Send Vulnerability Notification (from n8n)

```bash
curl -X POST http://localhost:5114/api/v1/n8n/vulnerability-ready \
  -H "Content-Type: application/json" \
  -d '{
    "scanId": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
    "projectName": "my-application",
    "tool": "TRIVY",
    "filePath": "/mnt/scan-results/trivy-results.json"
  }'
```

**Response (HTTP 200 OK):**

```json
{
  "status": "processed"
}
```

### Example: Multiple Tools for Same Scan

```bash
# First tool (Trivy)
curl -X POST http://localhost:5114/api/v1/n8n/vulnerability-ready \
  -H "Content-Type: application/json" \
  -d '{
    "scanId": "scan-123",
    "projectName": "my-app",
    "tool": "TRIVY",
    "filePath": "/mnt/scan-results/trivy.json"
  }'

# Second tool (ZAP)
curl -X POST http://localhost:5114/api/v1/n8n/vulnerability-ready \
  -H "Content-Type: application/json" \
  -d '{
    "scanId": "scan-123",
    "projectName": "my-app",
    "tool": "ZAP",
    "filePath": "/mnt/scan-results/zap.json"
  }'
```

Both results will be aggregated under the same `scanId`.

---

## ğŸ”Œ API Endpoints

### Process Vulnerability Results

```http
POST /api/v1/n8n/vulnerability-ready
Content-Type: application/json
```

**Request Body:**

```json
{
  "scanId": "unique-scan-id",
  "projectName": "project-name",
  "tool": "TRIVY",
  "filePath": "/path/to/results.json"
}
```

**Parameters:**
- `scanId` (string, required): Unique identifier for the scan
- `projectName` (string, required): Name of the scanned project
- `tool` (string, required): Security tool used ("TRIVY" or "ZAP")
- `filePath` (string, required): Absolute path to the result file in the volume

**Response:**

```json
{
  "status": "processed"
}
```

---

## ğŸ› ï¸ Supported Tools

### Trivy

**Purpose**: Container image and infrastructure-as-code vulnerability scanning

**Input Format**: Trivy JSON output

```json
{
  "Results": [
    {
      "Target": "alpine:3.14",
      "Vulnerabilities": [
        {
          "VulnerabilityID": "CVE-2021-36159",
          "PkgName": "libfetch",
          "Severity": "HIGH",
          "Title": "libfetch before 2021-07-26",
          "Description": "Detailed vulnerability description"
        }
      ]
    }
  ]
}
```

**Mapped Fields**:
- `VulnerabilityID` â†’ `Id`
- `Severity` â†’ `Severity`
- `Title` â†’ `Title`
- `Description` â†’ `Description`
- `Source` â†’ `"TRIVY"`

---

### OWASP ZAP

**Purpose**: Web application security scanning (DAST)

**Input Format**: ZAP JSON output

```json
{
  "Site": [
    {
      "Alerts": [
        {
          "Alert": "Cross Site Scripting (Reflected)",
          "Risk": "High",
          "Description": "XSS vulnerability description",
          "Solution": "Encode user input properly"
        }
      ]
    }
  ]
}
```

**Mapped Fields**:
- `Alert` (normalized) â†’ `Id`
- `Risk` â†’ `Severity`
- `Alert` â†’ `Title`
- `Description` â†’ `Description`
- `Source` â†’ `"ZAP"`

---

## ğŸ“Š Data Structures

### VulnerabilityNotificationDto (Input)

```json
{
  "scanId": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
  "projectName": "my-application",
  "tool": "TRIVY",
  "filePath": "/mnt/scan-results/scan-123-trivy.json"
}
```

### VulnerabilityFinding (Normalized)

```csharp
public class VulnerabilityFinding
{
    public string Id { get; set; }           // CVE-ID or Alert name
    public string Severity { get; set; }     // HIGH, MEDIUM, LOW
    public string Title { get; set; }
    public string Description { get; set; }
    public string Source { get; set; }       // TRIVY or ZAP
}
```

### ScanFinalResultDto (Output to RabbitMQ)

```json
{
  "scanId": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
  "projectName": "my-application",
  "passed": false,
  "totalFindings": 45,
  "highSeverity": 12,
  "mediumSeverity": 20,
  "lowSeverity": 13,
  "generatedAt": "2025-12-10T15:30:00.000Z"
}
```

---

## ğŸ° RabbitMQ Integration

### Exchange Configuration

- **Exchange Name**: `scan.results` (configurable)
- **Exchange Type**: Topic
- **Durable**: Yes
- **Routing Key**: `scan.result.final` (configurable)

### Message Format

Published messages are JSON-serialized `ScanFinalResultDto` objects with persistent delivery mode.

### Publisher Features

- **Automatic Retry**: Up to 3 attempts with exponential backoff
- **Connection Recovery**: Automatically recreates failed connections
- **Publisher Confirms**: Waits for broker acknowledgment
- **Persistent Messages**: Messages survive broker restarts

### Example Consumer (Python)

```python
import pika
import json

connection = pika.BlockingConnection(pika.ConnectionParameters('localhost'))
channel = connection.channel()

def callback(ch, method, properties, body):
    result = json.loads(body)
    print(f"Scan {result['scanId']} completed:")
    print(f"  Total: {result['totalFindings']}")
    print(f"  High: {result['highSeverity']}")
    print(f"  Passed: {result['passed']}")

channel.basic_consume(
    queue='vulnerability-results',
    on_message_callback=callback,
    auto_ack=True
)

channel.start_consuming()
```

---

## ğŸ“ File Reading

### Volume Configuration

Configure the base path for scan results in `appsettings.json`:

```json
{
  "Files": {
    "ResultsBasePath": "/mnt/scan-results"
  }
}
```

### Security Features

- **Path Validation**: Ensures requested files are within the configured base path
- **Absolute Path Resolution**: Prevents directory traversal attacks
- **Read-Only Access**: Opens files with read-only permissions
- **Shared Read Mode**: Allows concurrent access by multiple readers

### Supported Formats

- **JSON**: Primary format for both Trivy and ZAP results
- **UTF-8 Encoding**: All files expected to be UTF-8 encoded

---

## ğŸ”„ Result Aggregation

### How It Works

The `ResultAggregator` maintains an in-memory cache of partial results:

1. First notification for a `scanId` creates a new entry
2. Subsequent notifications with the same `scanId` append findings
3. Results are published immediately after each notification
4. Cache persists for the lifetime of the service

### Example Aggregation Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST: scanId=123, tool=TRIVY                   â”‚
â”‚ Findings: [CVE-123, CVE-456]                   â”‚
â”‚ â†’ Published: totalFindings=2                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST: scanId=123, tool=ZAP                     â”‚
â”‚ Findings: [XSS-001, SQLi-002]                  â”‚
â”‚ â†’ Aggregated with previous results             â”‚
â”‚ â†’ Published: totalFindings=4                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ› Troubleshooting

### Error: "File not found"

**Cause**: The specified file path doesn't exist or isn't accessible

**Solution**:
1. Verify the file exists: `ls -la /mnt/scan-results/`
2. Check file permissions: `chmod 644 /path/to/results.json`
3. Ensure the volume is mounted correctly in Docker/Kubernetes
4. Verify the path in the notification matches the actual file location

---

### Error: "FilePath outside allowed volume"

**Cause**: Security check prevents reading files outside the configured base path

**Solution**:
1. Ensure `Files:ResultsBasePath` is configured in `appsettings.json`
2. Verify the requested file is within the base path
3. Use absolute paths in notifications
4. Check for symlinks or shortcuts that might bypass security

---

### Error: "RabbitMQ connection failed"

**Cause**: Cannot connect to RabbitMQ broker

**Solution**:
1. Verify RabbitMQ is running: `docker ps | grep rabbitmq`
2. Test connection: `telnet localhost 5672`
3. Check credentials in `appsettings.json`
4. Review RabbitMQ logs: `docker logs rabbitmq-container`
5. Ensure firewall allows port 5672

---

### Error: "Unknown tool"

**Cause**: The `tool` field contains an unsupported value

**Solution**:
1. Use only supported tools: `"TRIVY"` or `"ZAP"` (case-insensitive)
2. Verify the tool name in your n8n workflow
3. Check for typos in the notification payload

---

### Results Not Published to RabbitMQ

**Cause**: Publisher fails silently or connection issues

**Solution**:
1. Check application logs for exceptions
2. Verify RabbitMQ exchange exists: Use RabbitMQ Management UI
3. Confirm routing key matches consumer binding
4. Test RabbitMQ connectivity manually
5. Increase log level to `Debug` in `appsettings.json`

---

### JSON Deserialization Errors

**Cause**: Result file format doesn't match expected structure

**Solution**:
1. Validate JSON syntax: `jq . /path/to/results.json`
2. Compare with expected format in documentation
3. Ensure Trivy/ZAP outputs JSON format (not XML or HTML)
4. Check for incomplete writes (file size = 0)
5. Review tool command-line options for output format

---

## ğŸ“ Logs

Logs are output to the console by default. Configure logging in `appsettings.json`:

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Sentinel.Vulnerability.Service": "Debug",
      "Sentinel.Vulnerability.Service.Publishers": "Debug"
    }
  }
}
```

### Important Log Messages

- `"RabbitMQ: conexiÃ³n establecida"` - Connection successful
- `"Publicado resultado del scan {ScanId}"` - Result published successfully
- `"RabbitMQ: intentando conectar"` - Attempting to connect/reconnect
- `"Archivo no existe: {Path}"` - File not found
- `"Error deserializando JSON"` - JSON parsing error

---

## ğŸš¢ Docker Deployment

### Dockerfile

```dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:8.0 AS base
WORKDIR /app
EXPOSE 5114

FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src
COPY ["Sentinel.Vulnerability.Service.csproj", "./"]
RUN dotnet restore
COPY . .
RUN dotnet build -c Release -o /app/build

FROM build AS publish
RUN dotnet publish -c Release -o /app/publish

FROM base AS final
WORKDIR /app
COPY --from=publish /app/publish .
ENTRYPOINT ["dotnet", "Sentinel.Vulnerability.Service.dll"]
```

### docker-compose.yml

```yaml
version: '3.8'

services:
  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: sentinel
      RABBITMQ_DEFAULT_PASS: sentinel123

  vulnerability-service:
    build: .
    ports:
      - "5114:5114"
    volumes:
      - ./scan-results:/mnt/scan-results:ro
    depends_on:
      - rabbitmq
    environment:
      RabbitMQ__Host: rabbitmq
      RabbitMQ__Username: sentinel
      RabbitMQ__Password: sentinel123
      Files__ResultsBasePath: /mnt/scan-results
```

Run:

```bash
docker-compose up -d
```

---

## ğŸ”— Integration with n8n

### n8n Workflow Example

```json
{
  "nodes": [
    {
      "name": "Execute Trivy Scan",
      "type": "n8n-nodes-base.executeCommand",
      "parameters": {
        "command": "trivy image -f json -o /results/trivy.json alpine:latest"
      }
    },
    {
      "name": "Notify Vulnerability Service",
      "type": "n8n-nodes-base.httpRequest",
      "parameters": {
        "method": "POST",
        "url": "http://vulnerability-service:5114/api/v1/n8n/vulnerability-ready",
        "bodyParameters": {
          "scanId": "={{ $json.scanId }}",
          "projectName": "alpine-image",
          "tool": "TRIVY",
          "filePath": "/mnt/scan-results/trivy.json"
        }
      }
    }
  ]
}
```

---

## ğŸ¤ Contributing

1. Fork the project
2. Create your feature branch (`git checkout -b feature/new-feature`)
3. Commit your changes (`git commit -m 'Add new feature'`)
4. Push to the branch (`git push origin feature/new-feature`)
5. Open a Pull Request

---

## ğŸ“„ License

This project is licensed under the MIT License. See `LICENSE` file for details.

---

## ğŸ‘¥ Team

- **Lead Developer**: [Your Name]
- **Software Architect**: [Name]
- **DevOps**: [Name]

---

## ğŸ“ Support

- **Email**: support@sentinel.com
- **Slack**: #sentinel-vulnerability-service
- **Jira**: [SENTINEL Project](https://jira.company.com/projects/SENTINEL)

---

## ğŸ”— Useful Links

- [Trivy Documentation](https://aquasecurity.github.io/trivy/)
- [OWASP ZAP User Guide](https://www.zaproxy.org/docs/)
- [RabbitMQ Tutorials](https://www.rabbitmq.com/getstarted.html)
- [.NET 8 Documentation](https://docs.microsoft.com/en-us/dotnet/)

---

**Thank you for using Sentinel Vulnerability Service!** ğŸ”ğŸ›¡ï¸
