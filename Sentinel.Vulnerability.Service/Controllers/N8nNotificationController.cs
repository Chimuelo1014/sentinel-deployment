using Microsoft.AspNetCore.Mvc;
using Sentinel.Vulnerability.Service.DTOs;
using Sentinel.Vulnerability.Service.Publishers;
using Sentinel.Vulnerability.Service.Services;
using System.Text.Json;
using Sentinel.Vulnerability.Service.Models;

namespace Sentinel.Vulnerability.Service.Controllers;
[ApiController]
[Route("api/v1/n8n")]
public class N8nNotificationController : ControllerBase
{
    private readonly IResultReader _reader;
    private readonly TrivyMapper _trivyMapper;
    private readonly ZapMapper _zapMapper;
    private readonly ResultAggregator _aggregator;
    private readonly IReportPublisher _publisher;

    public N8nNotificationController(
        IResultReader reader,
        TrivyMapper trivyMapper,
        ZapMapper zapMapper,
        ResultAggregator aggregator,
        IReportPublisher publisher)
    {
        _reader = reader;
        _trivyMapper = trivyMapper;
        _zapMapper = zapMapper;
        _aggregator = aggregator;
        _publisher = publisher;
    }

    [HttpPost("vulnerability-ready")]
    public async Task<IActionResult> Receive([FromBody] VulnerabilityNotificationDto dto)
    {
        var json = await _reader.ReadFileAsync(dto.FilePath);

        List<VulnerabilityFinding> findings = dto.Tool.ToUpper() switch
        {
            "TRIVY" => _trivyMapper.Map(JsonSerializer.Deserialize<Models.TrivyRawOutput>(json)!),
            "ZAP" => _zapMapper.Map(JsonSerializer.Deserialize<Models.ZapRawOutput>(json)!),
            _ => throw new Exception("Unknown tool")
        };

        var aggregated = _aggregator.AddPartialResult(dto.ScanId, dto.ProjectName, findings);

        // Publicamos siempre, aunque solo venga una parte.
        await _publisher.PublishFinalResultAsync(new ScanFinalResultDto
        {
            ScanId = aggregated.ScanId,
            ProjectName = aggregated.ProjectName,
            Passed = false, // para vulnerabilidades: nunca es PASS
            TotalFindings = aggregated.Findings.Count,
            HighSeverity = aggregated.Findings.Count(f => f.Severity.Equals("HIGH", StringComparison.OrdinalIgnoreCase)),
            MediumSeverity = aggregated.Findings.Count(f => f.Severity.Equals("MEDIUM", StringComparison.OrdinalIgnoreCase)),
            LowSeverity = aggregated.Findings.Count(f => f.Severity.Equals("LOW", StringComparison.OrdinalIgnoreCase)),
            GeneratedAt = DateTime.UtcNow.ToString("o")
        });

        return Ok(new { status = "processed" });
    }
}